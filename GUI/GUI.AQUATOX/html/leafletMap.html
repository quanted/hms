<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Leaflet-WebView2 test</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link rel="stylesheet" href="main.css" />
    <!-- Leaflet stuff -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
            integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
            crossorigin=""></script>

    <style> 

    .leaflet-tooltip { padding: 2px; }
        #map_container {
            background: white;
        }

    </style>
    <script src="https://unpkg.com/geojson-vt@3.2.0/geojson-vt.js"></script>
    <!-- geojson vt  -->
    <script src="JS/geojson-vt.js"></script>
    <script src="JS/leaflet-geojson-vt.js"></script>

</head>

<body>
    <div id="map_container">
        <div id="map"></div>
    </div>

    <script>
        var allShapes = null;
        var relH14 = null;
        var geoLayer;
        var rH14Layer;
        H14ZoomThresh = 9;
        var oldzoom = 6;
		var H14Zoom = false;  
		var H14Selected = false;

        // NWS Waterbodies
        const URL_NWS_WB =
            "https://mapservices.weather.noaa.gov/static/rest/services/nws_reference_maps/NWM_Lakes_and_Reservoirs/MapServer/0";
        // catchments
        const URL_NP21_CATCHMENTS =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/Catchments_NP21_Simplified/MapServer/0";
        // WBD - HUC_8
        const URL_NP21_HUCs =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/WBD_NP21_Simplified/MapServer/";
        // flowlines
        const URL_NP21_FLOWLINES =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/0";

        // build base map layer
        var MAP = L.map("map").fitBounds([
            [49.5, -125.02],
            [23.73, -69.05]
        ]);

        var markers = L.layerGroup();

        const CenterBox = L.Control.extend({
            options: {
                position: 'bottomright'
            },
            onAdd: function (MAP) {
                var container = L.DomUtil.create('div', 'center-box');
                container.style.cursor = 'default';

                L.DomEvent.on(container, 'click', function () {                       // Copy the lat lon to clipboard on click
                    var latLngText = this.innerHTML.replace('Map Center: ', '');
                    navigator.clipboard.writeText(latLngText).then(function () {}, function (err) {
                        console.error('Async: Could not copy text: ', err);
                    });
                });

                return container;
            },
            setContent: function (content) {
                this.getContainer().innerHTML = 'Map Center: ' + content;
            }
        });

        var centerBox = new CenterBox().addTo(MAP);

        var H14Maps = [];
        var H14Codes = [];
        var H14GeoJson = [];

        MAP.on('moveend', function () {
            if (H14Zoom && H14Selected) ShowHUC14Maps();
            centerBox.setContent(LatLngToArrayString(MAP.getCenter()));            
        });

        // Add event listener for base layer changes
        MAP.on('baselayerchange', function (event) {
            // Bring each H14Map layer to the front
            H14Maps.forEach(function (h14MapLayer) {
                if (h14MapLayer) {
                    h14MapLayer.bringToFront();
                }
            });
        });

        function ShowHUC14Maps() {
            if (!(H14Zoom && H14Selected)) {
                for (let i = 0; i < H14Codes.length; ++i) {
                    delete H14Codes[i];
                    if (H14Maps[i] != null) {
                        MAP.removeLayer(H14Maps[i]);
                    }
                    delete H14Maps[i];
                    delete H14GeoJson[i];
                };
                return;
            };

            var MB = MAP.getBounds();
            var E_Code = LonCode(MB.getEast());
            var W_Code = LonCode(MB.getWest());
            var S_Code = LatCode(MB.getSouth());
            var N_Code = LatCode(MB.getNorth());

            var Codes = [];
            Codes.push(E_Code + N_Code);
            Codes.push(E_Code + S_Code);
            Codes.push(W_Code + N_Code);
            Codes.push(W_Code + S_Code);

            Codes.forEach((code) => {
                if (!H14Codes.includes(code)) {
                    sendMessageToDotnet('H14' + code);    
                    H14Codes.push(code);
                }
            })

            for (let i = 0; i < H14Codes.length; ++i) {
                if (!Codes.includes(H14Codes[i])) {
                    delete H14Codes[i];
                    if (H14Maps[i] != null) MAP.removeLayer(H14Maps[i]);
                    delete H14Maps[i];
                    delete H14GeoJson[i];
                }
            }
        }

        function LonCode(lon) {
            var lonch;
            if (lon > -83.48) { lonch = "1" }
            else if (lon > -91.72) { lonch = "2" }
            else if (lon > -99.96) { lonch = "3" }
            else if (lon > -108.20) { lonch = "4" }
            else if (lon > -116.44) { lonch = "5" }
            else { lonch = "6" };

            return lonch; 
        }

        function LatCode(lat) {
            var latch;
            if (lat < 36.0) { latch = "0" }
            else if (lat < 41.5) { latch = "1" }
            else { latch = "2" }; 

            return latch;
        }

        function LatLngToArrayString(ll) {
            return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]";
        }

        MAP.on("layeradd", function (event) {
            if (geoLayer != null) { geoLayer.bringToFront(); }
        });

        var clickedHUC14 = null;
        var allShapes;

        MAP.on('click', function (e) {
            var x = e.latlng.lng;
            var y = e.latlng.lat;
        });

        MAP.on('zoomend', function () {
            newzoom = MAP.getZoom();
            if (newzoom < H14ZoomThresh) H14Zoom = false;
            if (newzoom >= H14ZoomThresh) {
                H14Zoom = true;  
                if (oldzoom <= H14ZoomThresh) {                    
                    ShowHUC14Maps();
                }
            }
            oldzoom = newzoom;
        });


        const LIGHT_GRAY=L.tileLayer("https://server.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:'Sources:Esri,HERE,Garmin,(c)OpenStreetMapcontributors,andtheGISusercommunity',}).addTo(MAP);
        const NAT_GEO = L.tileLayer(
            "https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",
            {
                attribution:
                    "Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC",
            }
        );

        const SATELLITE = L.tileLayer(
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
            {
                attribution:
                    "Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
            }
        );

        const Base_Maps = {
            "No Map": L.tileLayer(''),
            "Black and White": LIGHT_GRAY,
            "ESRI Natl. Geo.": NAT_GEO,
            "ESRI Imagery": SATELLITE,
        };


        const WB_LAYER = L.esri
            .featureLayer({
                url: URL_NWS_WB,
                onEachFeature: WBonEachFeature
            });

        function WBonEachFeature(feature, layer) {
            if (layer.feature.properties.GNIS_NAME != null) {
                var str = layer.feature.properties.GNIS_NAME.toString();
                if (str != ' ') { layer.bindTooltip(str, { permanent: false, opacity: 1.0 }); };
            };
        };

        function FLonEachFeature(feature, layer) {
            if ((feature.properties.FCODE == 56600) || (feature.properties.FLOWDIR == 0)) {
                layer.setStyle({ opacity: 0.0 });
                return;
            };

            if (layer.feature.properties.COMID != null) {
                var str = '';
                if (layer.feature.properties.GNIS_NAME != null) str = ", " + layer.feature.properties.GNIS_NAME.toString();
                if (str == ' ') str = '';
                str = layer.feature.properties.COMID.toString() + str;
                layer.bindTooltip(str, { opacity: 1.0 });
            };
        };

        function createHUCLayer(url, color, defaultColor, hucLevel, onEachFeature) {

            const layer = L.esri.featureLayer({
                url: url,
                onEachFeature: onEachFeature || null,
            });

            layer.setStyle({
                color: defaultColor,
                fillOpacity: 0,
                weight: 1,
            });

            return layer;

		}

        const HUC8 = createHUCLayer(URL_NP21_HUCs + "2", "blue", "red", 8);
        const HUC10 = createHUCLayer(URL_NP21_HUCs + "1", "blue", "maroon", 10);
        const HUC12 = createHUCLayer(URL_NP21_HUCs + "0", "red", "navy", 12);

        const FLOWLINES_LAYER = L.esri
            .featureLayer({
                url: URL_NP21_FLOWLINES,
                onEachFeature: FLonEachFeature
            });
        FLOWLINES_LAYER.setStyle({
            color: "black",
            fillOpacity: 0,
            weight: 1,
        });


        const OVERLAY_MAPS = {
            "HUC8 Boundaries": HUC8,
            "HUC10 Boundaries": HUC10,
            "HUC12 Boundaries": HUC12,
            "Flow Lines": FLOWLINES_LAYER,
            "NWS Lake/Res": WB_LAYER,
        };
        const LAYER_OPTIONS = L.control.layers(Base_Maps, OVERLAY_MAPS);
        LAYER_OPTIONS.addTo(MAP);

        // app interaction
        function handleMapClick(e) {
            //      const LAT_LNG = e.latlng;
            //      sendMessageToDotnet(
            //          `Message from map click lat: ${LAT_LNG.lat}, lng: ${LAT_LNG.lng}`
            //      );
        }
        MAP.on("click", handleMapClick);

        function concatGeoJSON(g1, g2) {
            return {
                "type": "FeatureCollection",
                "features": [...g1.features, ...g2.features]
            }
        }


        var geojsonStyle = {
            color: "#FF0800",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.01,
        };


        // app interaction
        function AddH14(gstr) {

            allShapes = JSON.parse(gstr);

            var options = {
                maxZoom: 20,
                minZoom: H14ZoomThresh,
                tolerance: 5,
                debug: 0,
                style: geojsonStyle
            };
            H14GeoJson.push(new L.GeoJSON(allShapes));
            H14Map = L.geoJson.vt(allShapes, options).addTo(MAP);
            H14Maps.push(H14Map);
            H14Map.bringToFront();

            sendMessageToDotnet('DoneDraw');
        }

        // app interaction
        function AddGeoJSON(gstr) {
            flowline = JSON.parse(gstr).stream_geometry;  //stream segments only
            if (allShapes == null) allShapes = flowline
            else allShapes = concatGeoJSON(allShapes, flowline);
        }

        function AddWBGeoJSON(gstr) {
            wb = JSON.parse(gstr);
            if (allShapes == null) allShapes = wb
            else allShapes = concatGeoJSON(allShapes, wb);
        }

        function AddRelevantH14s(gstr) {
            rh = JSON.parse(gstr);
            if (relH14 == null) relH14 = rh
            else relH14 = concatGeoJSON(relH14, rh);
            rH14Layer = L.geoJSON(relH14, {
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties.HUC14) {
                        layer.bindTooltip("HUC14: "+feature.properties.HUC14, {
                            permanent: false,
                            direction: 'auto'
                        });
                    }
                }
            });
            rH14Layer.setStyle({ weight: 2 });
            rH14Layer.eachLayer(function (layer) {
                if (layer.feature.geometry.type == 'Polygon') {
                    layer.setStyle({ color: 'navy', weight: 1, fillOpacity: 0.0 })
                }
            });
            rH14Layer.addTo(MAP);
            if (geoLayer) geoLayer.bringToFront();
        }

        function onEachFeature(feature, layer) {
            layer.on('click', function (e) {
                if (layer.feature.properties.COMID != null) sendMessageToDotnet(layer.feature.properties.COMID.toString());
            });

            if (layer.feature.properties.ID != null) {
                var str = '';
                if (feature.properties.Name) str = ", " + feature.properties.Name.toString();
                str = feature.properties.ID.toString() + str;
                layer.bindTooltip(str, {
                    permanent: false,
                    opacity: 1.0
                });
            };
        }

        function renderGeoJSON() {
            if (allShapes != null) {
                geoLayer = L.geoJSON(allShapes,
                    {
                        onEachFeature: onEachFeature
                    });
                geoLayer.setStyle({ weight: 2 });
                geoLayer.eachLayer(function (layer) {
                    if (layer.feature.geometry.type == 'Polygon') {
                        layer.setStyle({ color: 'navy', weight: 2 })
                    }
                });
                geoLayer.addTo(MAP);
                MAP.addLayer(markers);

                bounds = geoLayer.getBounds();
                MAP.fitBounds(bounds);
                var boundsStr = bounds.getSouthWest().lat + ',' + bounds.getSouthWest().lng + ',' + bounds.getNorthEast().lat + ',' + bounds.getNorthEast().lng;
                sendMessageToDotnet('Bounds|'+boundsStr);
            }
        }

        function ColorGeoJSON(COMID, linecolor) {
            geoLayer.eachLayer(function (layer) {
                if (layer.feature.properties.COMID == COMID) {
                    layer.setStyle({ color: linecolor });
                }
            })
        }

        function eraseGeoJSON() {
            if (geoLayer != null) MAP.removeLayer(geoLayer);
            markers.clearLayers();
            allShapes = null;
            geoLayer = null; // new L.geoJSON;
        }

        var greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [15, 25],
            iconAnchor: [6, 25],
            popupAnchor: [1, -25],
            shadowSize: [25, 25]
        });
        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [15, 25],
            iconAnchor: [6, 25],
            popupAnchor: [1, -25],
            shadowSize: [25, 25]
        });

        function AddMarker(mcolor, long, lat, msg) {
            var marker;
            if (mcolor == "green") marker = L.marker([lat, long], { icon: greenIcon });
            else marker = L.marker([lat, long], { icon: redIcon });
            marker.bindTooltip(msg);
            markers.addLayer(marker);
        }

        function Bounds(showstr) {
            if (showstr == "True") MAP.addLayer(markers);
            else MAP.removeLayer(markers);
        }

        function Labels(boostr) {
            if (geoLayer === null) return;
            var permanentlabels = false;
            if (boostr == "True") permanentlabels = true;

                geoLayer.eachLayer(function (layer) {
                    if (layer.feature.properties.COMID != null) {
                        var str = '';
                        if (layer.feature.properties.GNIS_NAME != null) str = ", " + layer.feature.properties.GNIS_NAME.toString();
                        if (str == ' ') str = '';
                        str = layer.feature.properties.COMID.toString() + str;
                        if (str != ' ') { layer.unbindTooltip(); layer.bindTooltip(str, { permanent: permanentlabels, opacity: 1.0 }); };
                    }
                });
        }

        function ShowH14(show) {
            if (show == "true") H14Selected = true;
               else H14Selected = false;
            ShowHUC14Maps();
        }


        // dotnet <=> js message handlers
        window.addEventListener('DOMContentLoaded', (event) => {
            window.chrome.webview.postMessage('DOMContentLoaded');
        });

        window.chrome.webview.addEventListener("message", (event) => {
            var messageArr = event.data.split("|");
            if (messageArr[0] == "ADD") AddGeoJSON(messageArr[1]);
            if (messageArr[0] == "ADDH14") AddH14(messageArr[1]);
            if (messageArr[0] == "ADDWB") AddWBGeoJSON(messageArr[1]);
            if (messageArr[0] == "RENDER") renderGeoJSON();
            if (messageArr[0] == "ERASE") eraseGeoJSON();
            if (messageArr[0] == "COLOR") ColorGeoJSON(parseInt(messageArr[1]), messageArr[2]);
            if (messageArr[0] == "MARKER") AddMarker(messageArr[1], messageArr[2], messageArr[3], messageArr[4]);
            if (messageArr[0] == "BOUNDS") Bounds(messageArr[1]);
            if (messageArr[0] == "LABELS") Labels(messageArr[1]);
            if (messageArr[0] == "SHOWH14") ShowH14(messageArr[1]); 
            if (messageArr[0] == "RH14s") AddRelevantH14s(messageArr[1]); 

            //                console.log(`message from dotnet: ${event.data}`);
            //                this.document.getElementById("message-bar").innerHTML =
            //                    event.data;
        });

        function sendMessageToDotnet(message) {
            window.chrome.webview.postMessage(message);
            }

    </script>
</body>
</html>
