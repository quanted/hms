<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <title>Leaflet-WebView2 test</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <link rel="stylesheet" href="main.css" />
        <!-- Leaflet stuff -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
            integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""
        ></script>
        <script
            src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
            integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
            crossorigin=""
        ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/1.1.0/leaflet.ajax.js"></script>
    </head>

    <body>
        <div id="map_container">
            <div id="map"></div>
        </div>


        <script>
            const DEFAULT_LAT = 33.95;
            const DEFAULT_LNG = -83.383333;
            const DEFAULT_ZOOM = 13;
            var allShapes = null;
            var geoLayer = null;

            // catchments
            const URL_NP21_CATCHMENTS =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/Catchments_NP21_Simplified/MapServer/0";
            // WBD - HUC_8
            const URL_NP21_HUC8 =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/WBD_NP21_Simplified/MapServer/2";
            // flowlines
            const URL_NP21_FLOWLINES =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/0";

            // build base map layer
            const MAP = L.map("map").setView(
                [DEFAULT_LAT, DEFAULT_LNG],
                DEFAULT_ZOOM
            );

            function styleClientPolygons2(json) {
              return {
                color: 'red',
                fillOpacity: 0.1
              }
            }

            function round(value, precision) {
              var multiplier = Math.pow(10, precision || 0);
              return Math.round(value * multiplier) / multiplier;
            }

            function processClientPolygons2(json, lyr) {
              var att = json.properties;
              lyr.bindTooltip(att.NAME, {
                opacity: 1.0
              });
            }            
            
            L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/{variant}/{z}/{x}/{y}{r}.{ext}", {
                attribution:
                    'Map tiles by <a href="http://stamen.com">Stamen Design</a>, ' +
                    '<a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; ' +
                    'Map data {attribution.OpenStreetMap}',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 20,
                variant: 'toner-lite',
                ext: 'png'} ).addTo(MAP);

            
            // build map layers
            const CATCHMENTS_LAYER = L.esri
                .featureLayer({
                    url: URL_NP21_CATCHMENTS,
                });
            CATCHMENTS_LAYER.setStyle({
                color: "orange",
                fillOpacity: 0,
            });

            const BOUNDARIES_LAYER = L.esri
                .featureLayer({
                    url: URL_NP21_HUC8,
                });
            BOUNDARIES_LAYER.setStyle({
                color: "red",
                fillOpacity: 0,
            });
            
            const FLOWLINES_LAYER = L.esri
                .featureLayer({
                    url: URL_NP21_FLOWLINES,
                });

            const OVERLAY_MAPS = {
                "HUC8 Boundaries": BOUNDARIES_LAYER,
                Catchments: CATCHMENTS_LAYER,
                "Flow Lines": FLOWLINES_LAYER,
            };
            const LAYER_OPTIONS = L.control.layers(null, OVERLAY_MAPS);
            LAYER_OPTIONS.addTo(MAP);

            // app interaction
            function handleMapClick(e) {
                const LAT_LNG = e.latlng;
                sendMessageToDotnet(
                    `Message from map click lat: ${LAT_LNG.lat}, lng: ${LAT_LNG.lng}`
                );
            }
            MAP.on("click", handleMapClick);

            function concatGeoJSON(g1, g2) {
                return {
                    "type": "FeatureCollection",
                    "features": [...g1.features, ...g2.features]
                }
            }

            // app interaction
            function AddGeoJSON(gstr) {
                
                flowline = JSON.parse(gstr).stream_geometry;
                if (allShapes == null) allShapes = flowline
                else allShapes = concatGeoJSON(allShapes, flowline);
                // sendMessageToDotnet(gstr);
            }

            function renderGeoJSON() {
                if (allShapes != null) {
                    geoLayer = L.geoJSON(allShapes);
                    geoLayer.addTo(MAP);
                    MAP.fitBounds(geoLayer.getBounds());  
                }
            }


            // dotnet <=> js message handlers
            window.chrome.webview.addEventListener("message", (event) => {
                var messageArr = event.data.split("|");
                if (messageArr[0] == "ADD") AddGeoJSON(messageArr[1]);
                if (messageArr[0] == "RENDER") renderGeoJSON();

//                console.log(`message from dotnet: ${event.data}`);
//                this.document.getElementById("message-bar").innerHTML =
//                    event.data;
            });

            function sendMessageToDotnet(message) {
                window.chrome.webview.postMessage(message);
            }
        </script>
    </body>
</html>
