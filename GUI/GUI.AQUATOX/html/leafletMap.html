<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Leaflet-WebView2 test</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link rel="stylesheet" href="main.css" />
    <!-- Leaflet stuff -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
            integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
            crossorigin=""></script>

    <style> 

    .leaflet-tooltip { padding: 2px; }
        #map_container {
            background: white;
        }

    </style>

</head>

<body>
    <div id="map_container">
        <div id="map"></div>
    </div>

 

    <script>
        var allShapes = null;
        var geoLayer;

        // NWS Waterbodies
        const URL_NWS_WB =
            "https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS/NWM_Lakes_and_Reservoirs/MapServer/0";
        // catchments
        const URL_NP21_CATCHMENTS =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/Catchments_NP21_Simplified/MapServer/0";
        // WBD - HUC_8
        const URL_NP21_HUC8 =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/WBD_NP21_Simplified/MapServer/2";
        // flowlines
        const URL_NP21_FLOWLINES =
            "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/0";

        // build base map layer
        var MAP = L.map("map").fitBounds([
            [49.5, -125.02],
            [23.73, -69.05]
        ]);

        var markers = L.layerGroup();

        const CenterBox = L.Control.extend({
            options: {
                position: 'bottomright'
            },
            onAdd: function (MAP) {
                return L.DomUtil.create('div', 'center-box');
            },
            setContent: function (content) {
                this.getContainer().innerHTML = 'Map Center: ' + content;
            }
        });

        var centerBox = new CenterBox().addTo(MAP);

        function LatLngToArrayString(ll) {
            return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]";
        }

        MAP.on("layeradd", function (event) {
            if (geoLayer != null) { geoLayer.bringToFront(); }
        });

        MAP.on('moveend', function () {
            centerBox.setContent(LatLngToArrayString(MAP.getCenter()));
        });

        const STAMEN_TONER = L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/{variant}/{z}/{x}/{y}{r}.{ext}", {
            attribution:
                'Map tiles by <a href="http://stamen.com">Stamen Design</a>, ' +
                '<a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; ' +
                'Map data {attribution.OpenStreetMap}',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 20,
            variant: 'toner-lite',
            ext: 'png'
        }).addTo(MAP);

        const NAT_GEO = L.tileLayer(
            "https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",
            {
                attribution:
                    "Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC",
            }
        );

        const SATELLITE = L.tileLayer(
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
            {
                attribution:
                    "Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
            }
        );

        const Base_Maps = {
            "No Map": L.tileLayer(''),
            "Black and White": STAMEN_TONER,
            "ESRI Natl. Geo.": NAT_GEO,
            "ESRI Imagery": SATELLITE,
        };
        //            const BASE_OPTIONS = L.control.layers()
        //((null, Base_Maps);
        //BASE_OPTIONS.addTo(MAP);


        const WB_LAYER = L.esri
            .featureLayer({
                url: URL_NWS_WB,
                onEachFeature: WBonEachFeature
            }
            );

        function WBonEachFeature(feature, layer) {
            if (layer.feature.properties.GNIS_NAME != null) {
                var str = layer.feature.properties.GNIS_NAME.toString();
                if (str != ' ') { layer.bindTooltip(str, { permanent: false, opacity: 1.0 }); };
            };
        };

        function FLonEachFeature(feature, layer) {
            if ((feature.properties.FCODE == 56600) || (feature.properties.FLOWDIR == 0)) {
                layer.setStyle({ opacity: 0.0 });
                return;
            };

            if (layer.feature.properties.COMID != null) {
                var str = '';
                if (layer.feature.properties.GNIS_NAME != null) str = ", " + layer.feature.properties.GNIS_NAME.toString();
                if (str == ' ') str = '';
                str = layer.feature.properties.COMID.toString() + str;
                layer.bindTooltip(str, { opacity: 1.0 });
            };
        };

        // build map layers
        //            const CATCHMENTS_LAYER = L.esri
        //                .featureLayer({
        //                    url: URL_NP21_CATCHMENTS,
        //                });
        //            CATCHMENTS_LAYER.setStyle({
        //                color: "orange",
        //                fillOpacity: 0,
        //                weight: 1,
        //            });



        const BOUNDARIES_LAYER = L.esri
            .featureLayer({
                url: URL_NP21_HUC8,
            });
        BOUNDARIES_LAYER.setStyle({
            color: "red",
            fillOpacity: 0,
            weight: 1,
        });

        const FLOWLINES_LAYER = L.esri
            .featureLayer({
                url: URL_NP21_FLOWLINES,
                onEachFeature: FLonEachFeature
            });
        FLOWLINES_LAYER.setStyle({
            color: "black",
            fillOpacity: 0,
            weight: 1,
        });


        const OVERLAY_MAPS = {
            "HUC8 Boundaries": BOUNDARIES_LAYER,
            //                Catchments: CATCHMENTS_LAYER,
            "Flow Lines": FLOWLINES_LAYER,
            "NWS Lake/Res": WB_LAYER,
        };
        const LAYER_OPTIONS = L.control.layers(Base_Maps, OVERLAY_MAPS);
        LAYER_OPTIONS.addTo(MAP);

        // app interaction
        function handleMapClick(e) {
            //      const LAT_LNG = e.latlng;
            //      sendMessageToDotnet(
            //          `Message from map click lat: ${LAT_LNG.lat}, lng: ${LAT_LNG.lng}`
            //      );
        }
        MAP.on("click", handleMapClick);

        function concatGeoJSON(g1, g2) {
            return {
                "type": "FeatureCollection",
                "features": [...g1.features, ...g2.features]
            }
        }

        // app interaction
        function AddGeoJSON(gstr) {
            flowline = JSON.parse(gstr).stream_geometry;  //stream segments only
            if (allShapes == null) allShapes = flowline
            else allShapes = concatGeoJSON(allShapes, flowline);
        }

        function AddWBGeoJSON(gstr) {
            wb = JSON.parse(gstr);
            if (allShapes == null) allShapes = wb
            else allShapes = concatGeoJSON(allShapes, wb);
        }

        function onEachFeature(feature, layer) {
            layer.on('click', function (e) {
                if (layer.feature.properties.COMID != null) sendMessageToDotnet(layer.feature.properties.COMID.toString());
            });

            if (layer.feature.properties.COMID != null) {
                var str = '';
                if (feature.properties.GNIS_NAME != null) str = ", " + feature.properties.GNIS_NAME.toString();
                if (str == ' ') str = '';
                str = feature.properties.COMID.toString() + str;
                layer.bindTooltip(str, {
                    permanent: false,
                    opacity: 1.0
                });
            };
        }

        function renderGeoJSON() {
            if (allShapes != null) {
                geoLayer = L.geoJSON(allShapes,
                    {
                        onEachFeature: onEachFeature
                    });
                geoLayer.setStyle({ weight: 2 });
                geoLayer.eachLayer(function (layer) {
                    if (layer.feature.geometry.type == 'Polygon') {
                        layer.setStyle({ color: 'navy', weight: 2 })
                    }
                });
                geoLayer.addTo(MAP);
                MAP.addLayer(markers);

                MAP.fitBounds(geoLayer.getBounds());
            }
        }

        function ColorGeoJSON(COMID, linecolor) {
            geoLayer.eachLayer(function (layer) {
                if (layer.feature.properties.COMID == COMID) {
                    layer.setStyle({ color: linecolor });
                }
            })
        }

        function eraseGeoJSON() {
            if (geoLayer != null) MAP.removeLayer(geoLayer);
            markers.clearLayers();
            allShapes = null;
            geoLayer = null; // new L.geoJSON;
        }

        var greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [15, 25],
            iconAnchor: [6, 25],
            popupAnchor: [1, -25],
            shadowSize: [25, 25]
        });
        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [15, 25],
            iconAnchor: [6, 25],
            popupAnchor: [1, -25],
            shadowSize: [25, 25]
        });

        function AddMarker(mcolor, long, lat, msg) {
            var marker;
            if (mcolor == "green") marker = L.marker([lat, long], { icon: greenIcon });
            else marker = L.marker([lat, long], { icon: redIcon });
            marker.bindTooltip(msg);
            markers.addLayer(marker);
        }

        function Bounds(showstr) {
            if (showstr == "True") MAP.addLayer(markers);
            else MAP.removeLayer(markers);
        }

        function Labels(boostr) {
            var permanentlabels = false;
            if (boostr == "True") permanentlabels = true;

            geoLayer.eachLayer(function (layer) {
                if (layer.feature.properties.COMID != null) {
                    var str = '';
                    if (layer.feature.properties.GNIS_NAME != null) str = ", " + layer.feature.properties.GNIS_NAME.toString();
                    if (str == ' ') str = '';
                    str = layer.feature.properties.COMID.toString() + str;
                    if (str != ' ') { layer.unbindTooltip(); layer.bindTooltip(str, { permanent: permanentlabels, opacity: 1.0 }); };
                }
            });
        }

        // dotnet <=> js message handlers
        window.addEventListener('DOMContentLoaded', (event) => {
            window.chrome.webview.postMessage('DOMContentLoaded');
        });

        window.chrome.webview.addEventListener("message", (event) => {
            var messageArr = event.data.split("|");
            if (messageArr[0] == "ADD") AddGeoJSON(messageArr[1]);
            if (messageArr[0] == "ADDWB") AddWBGeoJSON(messageArr[1]);
            if (messageArr[0] == "RENDER") renderGeoJSON();
            if (messageArr[0] == "ERASE") eraseGeoJSON();
            if (messageArr[0] == "COLOR") ColorGeoJSON(parseInt(messageArr[1]), messageArr[2]);
            if (messageArr[0] == "MARKER") AddMarker(messageArr[1], messageArr[2], messageArr[3], messageArr[4]);
            if (messageArr[0] == "BOUNDS") Bounds(messageArr[1]);
            if (messageArr[0] == "LABELS") Labels(messageArr[1]);

            //                console.log(`message from dotnet: ${event.data}`);
            //                this.document.getElementById("message-bar").innerHTML =
            //                    event.data;
        });

        function sendMessageToDotnet(message) {
            window.chrome.webview.postMessage(message);
        }
    </script>
</body>
</html>
